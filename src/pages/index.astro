---
import { type BlogPost, contentfulClient } from "../lib/contentful";
import FormattedTime from "../components/FormattedTime.astro";
import Main from "../layouts/Main.astro";
import Hero from "../assets/hero.png";
import { Image, getImage } from "astro:assets";
import { getOgpUrl } from "../lib/ogp";

const entries = await contentfulClient.getEntries<BlogPost>({
  content_type: "blogPost",
});

const articles = await Promise.all(
  entries.items.map(async (item) => {
    const { slug, title, subtitle, thumbnail, newsType } = item.fields;

    return {
      slug,
      subtitle,
      thumbnail: {
        src: await getImage({
          src: getOgpUrl({
            thumbnail: thumbnail?.fields.file?.url,
            title,
            highlight: newsType,
          }),
          format: "webp",
          width: 1440,
          height: 1080,
        }).then((result) => result.src),
        alt: thumbnail?.fields.description,
      },
      createdAt: new Date(item.sys.createdAt),
    };
  })
);
---

<Main>
  <section>
    <p class="text-center">
      <Image class="inline md:max-w-lg" src={Hero} alt="ちょっと役立たない情報をあなたに" />
    </p>
  </section>
  <section class="max-w-6xl mx-auto">
    <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {
        articles.map((article) => (
          <li class="mt-4">
            <a href={`/articles/${article.slug}/`}>
              <img
                class="aspect-[4/3] object-cover"
                src={article.thumbnail.src}
                alt={article.thumbnail.alt}
                width="1440"
                height="1080"
              />
              <h4 class="font-bold text-xl mt-2">{article.subtitle}</h4>
              <p class="mt-2">
                <FormattedTime date={article.createdAt} />
              </p>
            </a>
          </li>
        ))
      }
    </ul>
  </section>
</Main>
